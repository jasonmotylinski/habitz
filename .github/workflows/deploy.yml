name: deploy

on: [push]

jobs:

  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file for tests
        run: |
          echo "FLASK_ENV=testing" > .env
          echo "SECRET_KEY=test-secret-key" >> .env
          echo "DATABASE_URL=sqlite:///:memory:" >> .env
      
      - name: Run backend tests (pytest)
        env:
          DATABASE_URL: 'sqlite:///:memory:'
          FLASK_ENV: testing
        run: |
          pytest tests/ -v --tb=short -s 2>&1 | head -200
      
      - name: Check if package.json exists
        id: package_check
        run: |
          if [ -f package.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Node.js
        if: steps.package_check.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install frontend test dependencies
        if: steps.package_check.outputs.exists == 'true'
        run: |
          npm install --save-dev jest jest-environment-jsdom @testing-library/dom @testing-library/jest-dom
      
      - name: Run frontend tests (Jest)
        if: steps.package_check.outputs.exists == 'true'
        run: |
          npm test -- --coverage --passWithNoTests
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: cd /var/projects/habitz/ && ./scripts/prod/deploy.sh
